"use strict";(()=>{function e(e){return function(e){return e.charAt(0).toUpperCase()+e.slice(1)}(e.toLowerCase().replace(/[^a-zA-Z0-9]+(.)/g,((e,t)=>t.toUpperCase())))}var t=(e,...t)=>{console[e]("[35m[better-spotify-genres][0m",...t)};!function n(){if(!(Spicetify.CosmosAsync&&Spicetify.Platform&&Spicetify.URI&&Spicetify.Player.data))return void setTimeout(n,300);window.genrePopup=()=>b(),window.artistPageGenreOnClick=e=>function(e){Spicetify.Platform.History.push(`/search/${e}/playlists`)}(e),window._onGenreItemMouseOver=e=>{e.style.setProperty("color","var(--spice-text)")},window._onGenreItemMouseOut=e=>{e.style.setProperty("color","var(--spice-subtext)")};let r=[],i=[];const o=Spicetify.React;function a(e,t){Spicetify.LocalStorage.set(e,t)}function s(){try{return JSON.parse((e="showGenre:settings",Spicetify.LocalStorage.get(e)??"{}"))}catch{return a("showGenre:settings","{}"),{}}var e}const c={cached:{pop:"spotify:playlist:6gS3HhOiI17QNojjPuPzqc"}};let l=s();function p(e,t){if(e){let n=s();return n[e]=t,void a("showGenre:settings",JSON.stringify(n))}a("showGenre:settings",JSON.stringify(l))}async function u(e,t=null,n=document.body){return new Promise((r=>{if(document.querySelector(e))return r(document.querySelector(e));const i=new MutationObserver((()=>{document.querySelector(e)?(r(document.querySelector(e)),i.disconnect()):"number"==typeof t&&setTimeout((()=>{i.disconnect(),r(null)}),t)}));i.observe(n,{childList:!0,subtree:!0})}))}async function d(t){const n=l.cached[e(t)];if(null!=n)return{uri:n,genre:t};const r=new RegExp(`^the sound of ${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}$`,"i"),i=await Spicetify.CosmosAsync.get(`https://api.spotify.com/v1/search?q=${encodeURIComponent("The Sound of "+t)}&type=playlist`);for(const n of i.playlists.items)return"thesoundsofspotify"===n.owner.id&&r.test(n.name)?(l.cached[e(t)]=n.uri,p("cached",l.cached),{uri:n.uri,genre:t}):{uri:n.uri+"|||",genre:t};return{uri:null,genre:t}}async function m(e,t=null){const n=e.map((e=>async function(e){return(await Spicetify.CosmosAsync.get(`https://api.spotify.com/v1/artists/${e}`)).genres}(e.split(":")[2])));let i=(await Promise.allSettled(n)).map((e=>{if("fulfilled"===e.status)return e.value})).filter(Boolean).flat();if(0===i.length){let n;if("artist"===t)n=e[0].split(":")[2];else{if("recursive"===t)return[];n=Spicetify.Player.data.item.metadata.artist_uri.split(":")[2]}const r=await Spicetify.CosmosAsync.get(`wg://artist/v1/${n}/desktop?format=json`).catch((()=>null));if(!r)return[];if(!r.related_artists?.artists)return[];const o=r.related_artists.artists.map((e=>e.uri));let a=5;for(;25!==a;)i=await m(o.slice(a-5,a),"recursive"),0!=i.length?a=25:a+=5}return i=Array.from(new Set(i)),t||(r=i),i.slice(0,5)}async function f(){let e=function(){const e=Spicetify.Player.data.item.metadata,t=[e.artist_uri];for(let n=1;n<10;n++){const r=e[`artist_uri:${n}`];if(!r)break;t.push(r)}return t}(),n=await m(e);if(!n)return t("warn","No genres found for the current track, removing genres from UI..."),r=[],void P();const i=(await Promise.all(n.map((e=>d(e))))).filter((e=>null!==e.uri)).map((e=>`<a href="${e.uri.includes("|||")?'#" onclick="genrePopup()" ':e.uri+'"'} onmouseover="_onGenreItemMouseOver(this)" onmouseout="_onGenreItemMouseOut(this)" style="color: var(--spice-subtext)">${e.genre.replace(/(^\w{1})|([\s-]+\w{1})/g,(e=>e.toUpperCase()))}</a>`)).join("<span>, </span>");if(S||(S=document.createElement("div")),S.innerHTML=i,await x(),null!==v){S.style.fontSize="12px",S.style.color="var(--spice-misc)",S.style.setProperty("color","var(--spice-subtext)"),S.classList.add("ellipsis-one-line"),S.style.setProperty("grid-area","genres"),S.addEventListener("contextmenu",b);{let[e,t]=window.getComputedStyle(v).getPropertyValue("grid-template").split("/").map((e=>e.trim()));const n='"genres genres"';e.endsWith(n)||(e+=` ${n}`);const r=`${e} / ${t}`;v.style.setProperty("grid-template",r)}v.appendChild(S)}}Object.keys(c).forEach((e=>{const t=e;void 0===l[t]&&(l={...l,[t]:c[t]})})),p();const y=o.createElement("style",null,'.popup-row::after {\n          content: "";\n          display: table;\n          clear: both;\n      }\n      .popup-row .col {\n          display: flex;\n          padding: 10px 0;\n          align-items: center;\n      }\n      .popup-row .col.description {\n          float: left;\n          padding-right: 15px;\n      }\n      .popup-row .col.action {\n          float: right;\n          text-align: right;\n      }\n      .popup-row .div-title {\n          color: var(--spice-text);\n      }\n      .popup-row .divider {\n          height: 2px;\n          border-width: 0;\n          background-color: var(--spice-button-disabled);\n      }\n      .popup-row .space {\n          margin-bottom: 20px;\n          visibility: hidden;\n      }\n      .popup-row .info {\n          /* font-size: 13px; */\n      }\n      .popup-row .red {\n          font-size: 13px;\n          color: #59CE8F;\n      }\n      .popup-row .demo {\n          font-size: 13px;\n          color: #59CE8F;\n      }\n      .popup-row .little-space {\n          margin-bottom: 10px;\n      }\n      .popup-row .inputbox {\n          padding: 10px;\n          border-radius: 15px;\n          border: 0;\n          box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.06);\n      }\n      button.checkbox {\n          align-items: center;\n          color: var(--spice-text);\n          cursor: pointer;\n          display: flex;\n          margin-inline-start: 12px;\n      }\n      button.checkbox.disabled {\n          color: rgba(var(--spice-rgb-text), 0.3);\n      }\n      select {\n          color: var(--spice-text);\n          background: rgba(var(--spice-rgb-shadow), 0.7);\n          border: 0;\n          height: 32px;\n      }\n      ::-webkit-scrollbar {\n          width: 8px;\n      }\n      .login-button {\n          background-color: var(--spice-button);\n          border-radius: 8px;\n          border-style: none;\n          color: var(--spice-text);\n          cursor: pointer;\n          font-size: 14px;\n          height: 40px;\n          margin: 10px;\n          padding: 5px 10px;\n          text-align: center;\n      }\n      .green {\n          background-color: #76ba99;\n          color: #25316D;\n      }\n      .red {\n          background-color: #A9555E;\n      }\n      .small-button.red {\n          background-color: #A9555E !important;\n      }\n      input.small-input {\n          padding: 5px !important;\n          border-radius: 6px !important;\n          right: 0px !important;\n          margin: 5px;\n      }\n      .small-button {\n          margin-right: 20px;\n      }\n      .popup-row .inputbox[type="color"] {\n          background-color: var(--spice-custom-main-secondary) !important;\n          padding: 0px;\n          border-radius: 5px !important;\n          border: none;\n          margin-right: 10px;\n      }\n      .popup-row .inputbox[type="color"]::-webkit-color-swatch {\n          border-radius: 5px !important;\n          border: none;\n      }\n      .popup-row.search-div .col {\n          position: relative;\n      }\n      .popup-row .nord-search-container {\n          width: 100%;\n      }\n      .popup-row .nord-search-icon {\n          position: absolute;\n          margin: 10px;\n      }\n      .popup-row .nord-search {\n          padding: 10px 36px !important;\n          width: 100%;\n      }\n      .popup-row .display-none {\n          display: none !important;\n      }\n      .GenericModal[aria-label*="Genres of"] .main-trackCreditsModal-header {\n          color: var(--spice-custom-success);\n      }\n      .GenericModal[aria-label*="Genres of"] .main-trackCreditsModal-header {\n          color: var(--spice-custom-link-hover);\n      }');function g({name:e="",color:t="",onclickFun:n=()=>{}}){return o.createElement("button",{className:`login-button${t}`,onClick:()=>n()},e)}async function h(){const{artist_name:e,title:t}=Spicetify.Player.data.item.metadata;i=[];const n=await async function(e,t){const n=`https://ws.audioscrobbler.com/2.0/?method=track.getInfo&api_key=44654ea047786d90338c17331a5f5d95&artist=${encodeURIComponent(e)}&track=${encodeURIComponent(t)}&format=json`;try{const e=await fetch(n),t=await e.json();return"error"in t?null:t}catch{return null}}(e,t);if(!n)return;const r=n.track.toptags.tag;if(r)for(const e of r)/\d/.test(e.name)||i.push(e.name)}const w=o.createElement("div",null,y,o.createElement("p",{className:"popup-row"},'Tip: You can right click on genres in the "Player Bar" to open this popup.'),o.createElement("div",{className:"popup-row"},o.createElement("hr",{className:"space"},null)),o.createElement((function(){const[e,t]=o.useState(r);return Spicetify.Player.addEventListener("songchange",(()=>{setTimeout((()=>t(r)),500)})),e.map((e=>o.createElement(g,{name:e.replace(/(^\w{1})|([\s-]+\w{1})/g,(e=>e.toUpperCase())),onclickFun:async()=>{const t=await d(e);null===t.uri||t.uri.includes("|||")?Spicetify.Platform.History.push(`/search/${e}/playlists`):Spicetify.Platform.History.push(`/playlist/${t.uri.split(":")[2]}`),Spicetify.PopupModal.hide()}})))}),null,null),o.createElement((function(){if(0===i.length)return o.createElement("div",null,null);const[e,t]=o.useState(i);return Spicetify.Player.addEventListener("songchange",(()=>{setTimeout((()=>t(i)),500)})),o.createElement("div",null,o.createElement("div",{className:"popup-row"},o.createElement("hr",{className:"space"},null)),o.createElement("div",{className:"popup-row"},o.createElement("h1",{className:"div-title"},"Last FM Tags")),e.map((e=>o.createElement(g,{name:e.replace(/(^\w{1})|([\s-]+\w{1})/g,(e=>e.toUpperCase())),onclickFun:async()=>{Spicetify.Platform.History.push(`/search/${e}/playlists`),Spicetify.PopupModal.hide()}}))))}),null,null));function b(){Spicetify.PopupModal.display({title:'Genres of "'+Spicetify.Player.data.item.metadata.title.replace(/\(.+?\)/g,"").replace(/\[.+?\]/g,"").replace(/\s\-\s.+?$/,"").replace(/,.+?$/,"").trim()+'"',content:w,isLarge:!0})}let v=null;const x=async()=>{const e=(await Promise.all([u("div.main-trackInfo-container",1e3),u("div.main-nowPlayingWidget-trackInfo",1e3)])).find((e=>null!==e));if(!e)return t("error","Couldn't find the info container, genres will not be displayed."),void(v=null);v=e};let S=null;async function P(){await x();try{if(null===v||null===S)return;v.style.removeProperty("grid-template"),v.removeChild(S),S=null,v=null}catch{}}async function k(){if(Spicetify.Player.data.item.metadata.is_local||"track"!==Spicetify.URI.fromString(Spicetify.Player.data.item.uri).type)return t("warn","State is disabled or the current track is local, removing genres from UI..."),void P();await h(),await f()}async function E(e){let t=e.split("/");"artist"==t[1]&&3==t.length&&async function(e){if(!e)return;const t=e.map((async e=>{const t=await d(e);if(null!==t.uri)return[[`<a class="main-entityHeader-genreLink" href="${t.uri.includes("|||")?`#" data-value="${e}" onclick="artistPageGenreOnClick(this.getAttribute('data-value'))" `:t.uri+'"'} style="color: var(--spice-subtext); font-size: 1rem">${e.replace(/(^\w{1})|([\s-]+\w{1})/g,(e=>e.toUpperCase()))}</a>`],["<span>, </span>"]]}));let n=(await Promise.all(t)).flat(1/0);"<span>, </span>"==n[n.length-1]&&n.pop(),n.unshift("<span>Artist Genres : </span>");const r=n.join("");let i=document.createElement("div");i.className="main-entityHeader-detailsText genre-container",i.innerHTML=r;try{document.querySelector(".genre-container")?.remove()}catch{}let o=await u("div.main-entityHeader-headerText",1e3),a=await u("span.main-entityHeader-detailsText",1e3);o?.insertBefore(i,a)}(await m(["spotify:artist:"+t[2]],"artist"))}!function e(){Spicetify.Player.data?async function(){await k(),Spicetify.Player.addEventListener("songchange",k),await E(Spicetify.Platform.History.location.pathname),Spicetify.Platform.History.listen((e=>{E(e.pathname)}))}():setTimeout(e,1e3)}()}()})();